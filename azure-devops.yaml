name: $(version)-$(Build.SourceBranchName).$(Build.BuildId)

pool:
  name: Minikube

variables:
- group: devops
- group: Surveyor
- name: version
  value: 0.1.0

stages:
- stage: Dev
  jobs:
    - job: Version
      steps:
        - powershell: |
            if("$(Build.SourceBranchName)" -ne "main" ) { 
              Write-Host "##vso[task.setvariable variable=version]$(version)-$(Build.SourceBranchName).$(Build.BuildId)" 
            } else {
              Write-Host "##vso[build.updatebuildnumber]$(version)"
            }
          displayName: 'Configure Version'
        - powershell: |
            echo "$(pat)" | az devops login --organization https://dev.azure.com/magnoxium/
            $projectVariables = az pipelines variable-group list --organization https://dev.azure.com/magnoxium/ --project Andersoft | ConvertFrom-Json | where name -eq "Surveyor"
            $options = @{}
            $projectVariables.variables.PSObject.Properties | forEach { $options.add($_.Name, $_.Value.value)  }
            $options.keys | ForEach-Object { Write-Host "$($_)=$($options[$_])" }
            .\build.ps1 @options`
          displayName: 'Run Cake Build Script'